---
title: "Effectiveness of one dose of killed oral cholera vaccine in an endemic community in the Democratic Republic of Congo: A matched case-control study"

date: "05 December 2023"
author: 
output: html_document
 
---

This file presents the primary analyses from the manuscript _Effectiveness of one dose of killed oral cholera vaccine in an endemic community in the Democratic Republic of Congo: A matched case-control study_ by Malembaka et al. We have tried to make this code readable but if you have any issues please feel free to reach out to [Espoir Bwenge Malembaka](ebwenge1@jhu.edu) or [Andrew Azman](azman@jhu.edu).

```{r setup, include=FALSE}

pacman::p_load(
  tidyverse,
  reactable,
  survival,
  multcomp,
  flextable,
  gtsummary,
  here)


knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(echo=F,ft_max_row = 50, message=F, warning=F, eval=T, fig.align='center',fig.pos='ht')

flextable::use_df_printer()

```



```{r loading data}

# laoding the data
# The path should be updated to the public repository

## Study Period 1 (12-17 months post-vaccination)

df_period1 <- readRDS(here::here("data/df_period1.rds"))

## Study Period 1 (12-17 months post-vaccination)

df_period2 <- readRDS(here::here("data/df_period2.rds"))

## Study Period 2 (24-31 months post-vaccination)

df_combined <- readRDS(here::here("data/df_combined.rds"))

```


### Table 1: Characteristics of participants by case and control status


```{r table1, combined}

# Table 1: Characteristics of study participants by case-control status

df_table1_combined <- df_combined %>% 
  filter(cat_sex %in% c("female", "male")) %>% 
  mutate(vax_card = case_when(
    # vaccine_card == "Available" ~ "yes",
    # vaccine_card == "Unavailable" ~ "no",
    ind_vacc_card == "yes" ~ "yes",
    ind_vacc_card == "no" ~ "no"),
    
    case_status = case_when(
      case_control == 1  ~ "Cases",
      case_control == 0 ~ "Controls")) %>% 
  dplyr::select(case_status, age_vacc, age_group_vacc, cat_sex, ocv_all_dose, vax_card) 


table1_combined <- df_table1_combined %>% 
  tbl_summary(by=case_status,
              
              type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})"),                 
                          all_categorical() ~ "{n} ({p}%)"),
              
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
              
              label  = list(  
                age_vacc ~ "Age at vaccination (years)",
                age_group_vacc ~ "Age group at vaccination (years)",
                ocv_all_dose ~ "Vaccination status",
                cat_sex ~ "Sex",
                vax_card ~ "Vaccination card"
                ),
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) 

# Display table 1 as a flextable object

table1_combined  %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 

```

#### Table 2. Characteristics of study participants in the vaccine effectiveness analysis 24-36 months after vaccination (Study Period 2)


```{r table2, study period 2}

# Characteristics of study participants in the vaccine effectiveness analysis 24-31 months after vaccination

table2 <- df_period2 %>% 
  dplyr::select(case_status, age_vacc, age_group_vacc, cat_sex, educ, occup, hh_size, toilet_shared, toilet_type, handwash_soapwater,  wealth_index, ocv_all_dose, vaccine_card) %>% 
  mutate(wealth_index = wealth_index *100) %>% 
  tbl_summary(by=case_status,
              
         type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})"),                 
                          all_categorical() ~ "{n} ({p}%)"),
         
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
         
              label  = list(  
                age_vacc ~ "Age at vaccination (years)",
                age_group_vacc ~ "Age group at vaccination (years)",
                ocv_all_dose ~ "Vaccination status",
                cat_sex ~ "Sex",
                educ ~ "Education attainment", 
                hh_size ~ "Household size", 
                toilet_shared ~ "Shared toilet", 
                toilet_type ~ "Toilet type", 
                handwash_soapwater ~ "Soap and water available for handwashing",  
                wealth_index ~ "Wealth index",
                occup ~ "Occupation",
                vaccine_card ~ "Vaccination card"
                ),
        missing_text = "Missing" ) %>% 
  add_p(pvalue_fun = ~style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) 


table2 %>% 
  as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 


```


#### Table S3. Characteristics of participants in the 12-17 months vaccine effectiveness study


```{r characteristics of participants in study period 1}

# Table 1: Characteristics of study participants by case-control status

df_table1_retro <- df_period1 %>% 
  filter(cat_sex %in% c("female", "male")) %>% 
  mutate(vax_card = case_when(
    vaccine_card == "Available" ~ "yes",
    vaccine_card == "Unavailable" ~ "no")) %>% 
  dplyr::select(case_status, age_vacc, age_group_vacc, cat_sex, ocv_all_dose, vaccine_card) 

table1_retro <- df_table1_retro %>% 
  tbl_summary(by=case_status,
              
              type = all_continuous() ~ "continuous2",       # indicate that you want to print multiple statistics 
         statistic = list(all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}, {p75})"),                 
                          all_categorical() ~ "{n} ({p}%)"),
              
              digits = list(all_categorical() ~ c(0, 1),
                            all_continuous() ~ 1),
              
              label  = list(  
                age_vacc ~ "Age at vaccination (years)",
                age_group_vacc ~ "Age group at vaccination (years)",
                ocv_all_dose ~ "Vaccination status",
                cat_sex ~ "Sex",
                vaccine_card ~ "Vaccination card"
                ),
        missing_text = "Missing"
        #,
         #     percent = "row"
        #      missing= "no"
                      ) %>% 
  add_p(pvalue_fun = ~style_pvalue(., digits = 3)) %>% 
  add_overall(last = F) 

# Display table 1 as a flextable object

table1_retro  %>% as_flex_table() %>% 
  flextable::set_table_properties( width = 1, layout = "autofit") 

```


### Effective sample size


```{r function for effective numbers}

# For cases

get_n_cases_single_dose <- function(df) { 
 
  effective_n_cases = df %>% 
  filter(!is.na(ocv_single_dose)) %>% 
  dplyr::select(id_case, record_id, ocv_single_dose, ocv_all_dose, case_control) %>% 
  group_by(id_case) %>% 
  mutate(vaccine_case = first(ocv_single_dose)) %>% 
  mutate(same_vacc = ifelse(ocv_single_dose != vaccine_case, 1 , 0)) %>%  ## 1 = controls with vaccination status different from that of the case
  dplyr::add_count(id_case, name="n_cc_set") %>% 
  mutate(n_different = sum(same_vacc)) %>% 
  filter(case_control ==1) %>% 
  filter(n_different >0) %>% 
  distinct(id_case, .keep_all = TRUE) %>% 
  nrow()

  return(effective_n_cases)
}

# at least two doses

get_n_cases_atleast_1dose <- function(df) { 
  
 
  effective_n_cases = df %>% 
  filter(!is.na(ocv_atleast_1dose)) %>% 
  dplyr::select(id_case, record_id, ocv_atleast_1dose, ocv_all_dose, case_control) %>% 
  group_by(id_case) %>% 
  mutate(vaccine_case = first(ocv_atleast_1dose)) %>% 
  mutate(same_vacc = ifelse(ocv_atleast_1dose != vaccine_case, 1 , 0)) %>%  ## 1 = controls with vaccination status different from that of the case
  dplyr::add_count(id_case, name="n_cc_set") %>% 
  mutate(n_different = sum(same_vacc)) %>% 
  filter(case_control ==1) %>% 
  filter(n_different >0) %>% 
  distinct(id_case, .keep_all = TRUE) %>% 
  nrow()

  return(effective_n_cases)
}

# two doses

get_n_cases_2dose <- function(df) { 
  
  effective_n_cases = df %>% 
  filter(!is.na(ocv_2dose)) %>% 
  dplyr::select(id_case, record_id, ocv_2dose, ocv_all_dose, case_control) %>% 
  group_by(id_case) %>% 
  mutate(vaccine_case = first(ocv_2dose)) %>% 
  mutate(same_vacc = ifelse(ocv_2dose != vaccine_case, 1 , 0)) %>%  ## 1 = controls with vaccination status different from that of the case
  dplyr::add_count(id_case, name="n_cc_set") %>% 
  mutate(n_different = sum(same_vacc)) %>% 
  filter(case_control ==1) %>% 
  filter(n_different >0) %>% 
  distinct(id_case, .keep_all = TRUE) %>% 
  nrow()

  return(effective_n_cases)
}

# Function for controls
## single dose, effective n of controls 

get_n_controls_single_dose <- function(df) { 
 
  effective_n_controls  = df %>% 
  filter(!is.na(ocv_single_dose)) %>% 
  dplyr::select(id_case, record_id, ocv_all_dose, ocv_single_dose, case_control) %>% 
  group_by(id_case) %>% 
  mutate(vaccine_case = first(ocv_single_dose)) %>% 
  mutate(same_vacc = ifelse(ocv_single_dose != vaccine_case, 1 , 0)) %>%  ## 1 = controls with vaccination status different from that of the case
  dplyr::add_count(id_case, name="n_cc_set") %>% 
  mutate(n_different = sum(same_vacc)) %>% 
  filter(case_control ==0) %>% 
  filter(n_different >0) %>% 
  distinct(id_case, .keep_all = TRUE) %>% 
  ungroup() %>% 
  summarise(n_controls_effective = sum(n_different)) %>% 
  pull(n_controls_effective)
  
  return(effective_n_controls)
  
}
  
  ## at least 1 dose, effective n of controls 

get_n_controls_atleast_1dose <- function(df) { 
 
  effective_n_controls  = df %>% 
  filter(!is.na(ocv_atleast_1dose)) %>% 
  dplyr::select(id_case, record_id, ocv_all_dose, ocv_atleast_1dose, case_control) %>% 
  group_by(id_case) %>% 
  mutate(vaccine_case = first(ocv_atleast_1dose)) %>% 
  mutate(same_vacc = ifelse(ocv_atleast_1dose != vaccine_case, 1 , 0)) %>%  ## 1 = controls with vaccination status different from that of the case
  dplyr::add_count(id_case, name="n_cc_set") %>% 
  mutate(n_different = sum(same_vacc)) %>% 
  filter(case_control ==0) %>% 
  filter(n_different >0) %>% 
  distinct(id_case, .keep_all = TRUE) %>% 
  ungroup() %>% 
  summarise(n_controls_effective = sum(n_different)) %>% 
  pull(n_controls_effective)
  
  return(effective_n_controls)
  
}

## effective n of controls , 2 doses

get_n_controls_2dose <- function(df) { 
 
  effective_n_controls  = df %>% 
  filter(!is.na(ocv_2dose)) %>% 
  dplyr::select(id_case, record_id, ocv_all_dose, ocv_2dose, case_control) %>% 
  group_by(id_case) %>% 
  mutate(vaccine_case = first(ocv_2dose)) %>% 
  mutate(same_vacc = ifelse(ocv_2dose != vaccine_case, 1 , 0)) %>%  ## 1 = controls with vaccination status different from that of the case
  dplyr::add_count(id_case, name="n_cc_set") %>% 
  mutate(n_different = sum(same_vacc)) %>% 
  filter(case_control ==0) %>% 
  filter(n_different >0) %>% 
  distinct(id_case, .keep_all = TRUE) %>% 
  ungroup() %>% 
  summarise(n_controls_effective = sum(n_different)) %>% 
  pull(n_controls_effective)
  
  return(effective_n_controls)
  
}

```


```{r run funciton to get effective n of cases and controls }
# SINGLE DOSE
# Single dose, study period 2 (prospective)
# All ages

effective_n_cases_1dose_all_pro = get_n_cases_single_dose(df = df_period2)
effective_n_controls_1dose_all_pro  = get_n_controls_single_dose(df = df_period2)

# Participants above 5 years of age

effective_n_cases_1dose_above5_pro = get_n_cases_single_dose(df = df_period2 %>% filter(age_vacc >= 5)) 
effective_n_controls_1dose_above5_pro = get_n_controls_single_dose(df = df_period2 %>% filter(age_vacc >= 5))

# Participants under 5 years of age

effective_n_cases_1dose_under5_pro = get_n_cases_single_dose(df = df_period2 %>% filter(age_vacc < 5)) 
effective_n_controls_1dose_under5_pro = get_n_controls_single_dose(df = df_period2 %>% filter(age_vacc < 5))

# Single dose, retrospective case-control study ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
# All participants

effective_n_cases_1dose_all_retro  = get_n_cases_single_dose(df = df_period1) 
effective_n_controls_1dose_all_retro = get_n_controls_single_dose(df = df_period1) 

# Participants above 5 years of age

effective_n_cases_1dose_above5_retro = get_n_cases_single_dose(df = df_period1 %>% filter(age_vacc >= 5)) 
effective_n_controls_1dose_above5_retro = get_n_controls_single_dose(df = df_period1 %>% filter(age_vacc >= 5))

# Participants under 5 years of age

effective_n_cases_1dose_under5_retro = get_n_cases_single_dose(df = df_period1 %>% filter(age_vacc < 5)) 
effective_n_controls_1dose_under5_retro = get_n_controls_single_dose(df = df_period1 %>% filter(age_vacc < 5)) 
 

# Combined data  ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
####Single dose, combined data
##### All ages, cases, combined data, single dose

effective_n_cases_1dose_all_combined  = get_n_cases_single_dose(df = df_combined) 
effective_n_controls_1dose_all_combined = get_n_controls_single_dose(df = df_combined) 


#  ≥ 5 years of age, combined data, single dose

effective_n_cases_1dose_above5_combined = get_n_cases_single_dose(df = df_combined %>% filter(age_vacc >= 5)) 
effective_n_controls_1dose_above5_combined = get_n_controls_single_dose(df = df_combined %>% filter(age_vacc >= 5))

### under 5 years of age, single dose, combined data

effective_n_cases_1dose_under5_combined = get_n_cases_single_dose(df = df_combined %>% filter(age_vacc < 5)) 
effective_n_controls_1dose_under5_combined = get_n_controls_single_dose(df = df_combined %>% filter(age_vacc < 5)) 
 

## TWO DOSES

effective_n_cases_2dose_all_pro = get_n_cases_2dose(df = df_period2)
effective_n_controls_2dose_all_pro  = get_n_controls_2dose(df = df_period2)

# Participants above 5 years of age

effective_n_cases_2dose_above5_pro = get_n_cases_2dose(df = df_period2 %>% filter(age_vacc >= 5)) 
effective_n_controls_2dose_above5_pro = get_n_controls_2dose(df = df_period2 %>% filter(age_vacc >= 5))

# Participants under 5 years of age

effective_n_cases_2dose_under5_pro = get_n_cases_2dose(df = df_period2 %>% filter(age_vacc < 5)) 
effective_n_controls_2dose_under5_pro = get_n_controls_2dose(df = df_period2 %>% filter(age_vacc < 5))

# Single dose, retrospective case-control study ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
# All participants

effective_n_cases_2dose_all_retro  = get_n_cases_2dose(df = df_period1) 
effective_n_controls_2dose_all_retro = get_n_controls_2dose(df = df_period1) 

# Participants above 5 years of age

effective_n_cases_2dose_above5_retro = get_n_cases_2dose(df = df_period1 %>% filter(age_vacc >= 5)) 
effective_n_controls_2dose_above5_retro = get_n_controls_2dose(df = df_period1 %>% filter(age_vacc >= 5))

# Participants under 5 years of age

effective_n_cases_2dose_under5_retro = get_n_cases_2dose(df = df_period1 %>% filter(age_vacc < 5)) 
effective_n_controls_2dose_under5_retro = get_n_controls_2dose(df = df_period1 %>% filter(age_vacc < 5)) 
 

# Combined data  ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
####Single dose, combined data
##### All ages, cases, combined data, single dose

effective_n_cases_2dose_all_combined  = get_n_cases_2dose(df = df_combined) 
effective_n_controls_2dose_all_combined = get_n_controls_2dose(df = df_combined) 


#  ≥ 5 years of age, combined data, single dose

effective_n_cases_2dose_above5_combined = get_n_cases_2dose(df = df_combined %>% filter(age_vacc >= 5)) 
effective_n_controls_2dose_above5_combined = get_n_controls_2dose(df = df_combined %>% filter(age_vacc >= 5))

### under 5 years of age, single dose, combined data

effective_n_cases_2dose_under5_combined = get_n_cases_2dose(df = df_combined %>% filter(age_vacc < 5)) 
effective_n_controls_2dose_under5_combined = get_n_controls_2dose(df = df_combined %>% filter(age_vacc < 5)) 
 

# AT LEAST 1 DOSE

effective_n_cases_atleast_1dose_all_pro = get_n_cases_atleast_1dose(df = df_period2)
effective_n_controls_atleast_1dose_all_pro  = get_n_controls_atleast_1dose(df = df_period2)

# Participants above 5 years of age

effective_n_cases_atleast_1dose_above5_pro = get_n_cases_atleast_1dose(df = df_period2 %>% filter(age_vacc >= 5)) 
effective_n_controls_atleast_1dose_above5_pro = get_n_controls_atleast_1dose(df = df_period2 %>% filter(age_vacc >= 5))

# Participants under 5 years of age

effective_n_cases_atleast_1dose_under5_pro = get_n_cases_atleast_1dose(df = df_period2 %>% filter(age_vacc < 5)) 
effective_n_controls_atleast_1dose_under5_pro = get_n_controls_atleast_1dose(df = df_period2 %>% filter(age_vacc < 5))

# Single dose, retrospective case-control study ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
# All participants

effective_n_cases_atleast_1dose_all_retro  = get_n_cases_atleast_1dose(df = df_period1) 
effective_n_controls_atleast_1dose_all_retro = get_n_controls_atleast_1dose(df = df_period1) 

# Participants above 5 years of age

effective_n_cases_atleast_1dose_above5_retro = get_n_cases_atleast_1dose(df = df_period1 %>% filter(age_vacc >= 5)) 
effective_n_controls_atleast_1dose_above5_retro = get_n_controls_atleast_1dose(df = df_period1 %>% filter(age_vacc >= 5))

# Participants under 5 years of age

effective_n_cases_atleast_1dose_under5_retro = get_n_cases_atleast_1dose(df = df_period1 %>% filter(age_vacc < 5)) 
effective_n_controls_atleast_1dose_under5_retro = get_n_controls_atleast_1dose(df = df_period1 %>% filter(age_vacc < 5)) 
 

# Combined data  ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
####Single dose, combined data
##### All ages, cases, combined data, single dose

effective_n_cases_atleast_1dose_all_combined  = get_n_cases_atleast_1dose(df = df_combined) 
effective_n_controls_atleast_1dose_all_combined = get_n_controls_atleast_1dose(df = df_combined) 


#  ≥ 5 years of age, combined data, single dose

effective_n_cases_atleast_1dose_above5_combined = get_n_cases_atleast_1dose(df = df_combined %>% filter(age_vacc >= 5)) 
effective_n_controls_atleast_1dose_above5_combined = get_n_controls_atleast_1dose(df = df_combined %>% filter(age_vacc >= 5))

### under 5 years of age, single dose, combined data

effective_n_cases_atleast_1dose_under5_combined = get_n_cases_atleast_1dose(df = df_combined %>% filter(age_vacc < 5)) 
effective_n_controls_atleast_1dose_under5_combined = get_n_controls_atleast_1dose(df = df_combined %>% filter(age_vacc < 5)) 
 

# Data frame with effective n of cases

df_effective_sample <- data.frame(Duration = c(rep("One year", 3), rep("Two years", 3), rep("Combined", 3)),
                                  
                                  Population=rep(c("All participants", "Participants above 5 years of age", "Participants under 5 years of age"), 3),
                                  
                                  effective_n_cases_1dose = c(effective_n_cases_1dose_all_retro, 
                                                        effective_n_cases_1dose_above5_retro,
                                                        effective_n_cases_1dose_under5_retro,
                                                        effective_n_cases_1dose_all_pro,
                                                        effective_n_cases_1dose_above5_pro,
                                                        effective_n_cases_1dose_under5_pro,
                                                        effective_n_cases_1dose_all_combined,
                                                        effective_n_cases_1dose_above5_combined,
                                                        effective_n_cases_1dose_under5_combined),
                                  effective_n_cases_2dose  = c(effective_n_cases_2dose_all_retro, 
                                                        effective_n_cases_2dose_above5_retro,
                                                        effective_n_cases_2dose_under5_retro,
                                                        effective_n_cases_2dose_all_pro,
                                                        effective_n_cases_2dose_above5_pro,
                                                        effective_n_cases_2dose_under5_pro,
                                                        effective_n_cases_2dose_all_combined,
                                                        effective_n_cases_2dose_above5_combined,
                                                        effective_n_cases_2dose_under5_combined),
                                  effective_n_cases_atleast_1dose  = c(effective_n_cases_atleast_1dose_all_retro, 
                                                        effective_n_cases_atleast_1dose_above5_retro,
                                                        effective_n_cases_atleast_1dose_under5_retro,
                                                        effective_n_cases_atleast_1dose_all_pro,
                                                        effective_n_cases_atleast_1dose_above5_pro,
                                                        effective_n_cases_atleast_1dose_under5_pro,
                                                        effective_n_cases_atleast_1dose_all_combined,
                                                        effective_n_cases_atleast_1dose_above5_combined,
                                                        effective_n_cases_atleast_1dose_under5_combined),
                                  effective_n_controls_1dose = c(effective_n_controls_1dose_all_retro, 
                                                        effective_n_controls_1dose_above5_retro,
                                                        effective_n_controls_1dose_under5_retro,
                                                        effective_n_controls_1dose_all_pro,
                                                        effective_n_controls_1dose_above5_pro,
                                                        effective_n_controls_1dose_under5_pro,
                                                        effective_n_controls_1dose_all_combined,
                                                        effective_n_controls_1dose_above5_combined,
                                                        effective_n_controls_1dose_under5_combined),
                                  effective_n_controls_2dose  = c(effective_n_controls_2dose_all_retro, 
                                                        effective_n_controls_2dose_above5_retro,
                                                        effective_n_controls_2dose_under5_retro,
                                                        effective_n_controls_2dose_all_pro,
                                                        effective_n_controls_2dose_above5_pro,
                                                        effective_n_controls_2dose_under5_pro,
                                                        effective_n_controls_2dose_all_combined,
                                                        effective_n_controls_2dose_above5_combined,
                                                        effective_n_controls_2dose_under5_combined),
                                  effective_n_controls_atleast_1dose  = c(effective_n_controls_atleast_1dose_all_retro, 
                                                        effective_n_controls_atleast_1dose_above5_retro,
                                                        effective_n_controls_atleast_1dose_under5_retro,
                                                        effective_n_controls_atleast_1dose_all_pro,
                                                        effective_n_controls_atleast_1dose_above5_pro,
                                                        effective_n_controls_atleast_1dose_under5_pro,
                                                        effective_n_controls_atleast_1dose_all_combined,
                                                        effective_n_controls_atleast_1dose_above5_combined,
                                                        effective_n_controls_atleast_1dose_under5_combined))
                                  
                                  
```



### Oral cholera vaccine effectiveness


```{r model function for matched case-control design}

ocv1 = "ocv_single_dose"
ocv2 = "ocv_2dose"
ocv3 = "ocv_atleast_1dose"
outcome = "case_control"


df_period2 <- df_period2 %>% 
  mutate(n_hh_centered = n_household -  (df_period2 |> dplyr::summarize(ma= mean(n_household, na.rm = TRUE)) |> pull(ma)),
         wealth_centered = wealth_index - (df_period2 |> dplyr::summarize(ma= mean(wealth_index, na.rm = TRUE)) |> pull(ma)))

confounders <- df_period2 %>% 
  dplyr::select(occup, toilet_shared, drinking_water_source, handwash_soapwater) %>% colnames()

# Function to do conditional logistic regression with age interaction 
# This should produce both the overall and age-specific estimates and 95% CIs


regress_unadj_match_ageint <- function(df,ocv){
 
  # adding some extra fields to the data frame
  df <- df |> dplyr::mutate(u5=if_else(age_vacc<5,TRUE,FALSE),
                     ocv_single_dose = case_when(ocv_single_dose=="Single dose" ~ TRUE,
                     ocv_single_dose=="Not vaccinated" ~ FALSE,
                     TRUE ~ NA),
                     ocv_2dose = case_when(ocv_2dose=="Two doses" ~ TRUE,
                      ocv_2dose=="Not vaccinated" ~ FALSE,
                      TRUE ~ NA),
                     ocv_atleast_1dose=case_when(ocv_atleast_1dose=="One dose or more" ~ TRUE,
                      ocv_atleast_1dose=="Not vaccinated" ~ FALSE,
                      TRUE ~ NA), 
                     vac=case_when(.data[[ocv]]==TRUE ~ TRUE,
                                   .data[[ocv]]==FALSE ~ FALSE,
                                   TRUE ~ NA),
                     vac_u5=vac*u5)

  formula <- as.formula(paste0(outcome, "~ vac + vac_u5 + strata(id_case)"))
  
  model  <- clogit(formula, data = df)
  
  ## get estimates for o5
  glht_o5 <- glht(model, linfct = t(c(1,0)))
  conf_int_obj_o5 <- c(1-exp(confint(glht_o5)$confint))
  ve_o5 <- (conf_int_obj_o5[1] * 100) |> round(1)
  ve_o5_lb <- (conf_int_obj_o5[3] * 100) |> round(1)
  ve_o5_ub <- (conf_int_obj_o5[2] * 100) |> round(1)
 

  ## get estimates for u5
  glht_u5 <- glht(model, linfct = t(c(1,1)))
  conf_int_obj_u5 <- c(1-exp(confint(glht_u5 )$confint))
  ve_u5 <- (conf_int_obj_u5[1] * 100) |> round(1)
  ve_u5_lb <- (conf_int_obj_u5[3] * 100) |> round(1)
  ve_u5_ub <- (conf_int_obj_u5[2] * 100) |> round(1)

  
  ## get overall estimates 
  glht_overall <- glht(model, linfct = t(c(1,mean(df$u5))))
  conf_int_obj_overall <- 1-exp(confint(glht_overall)$confint) # overall estimate weighted by proportion of cases u5
  ve_overall <- (conf_int_obj_overall[1] * 100) |> round(1)
  ve_overall_lb <- (conf_int_obj_overall[3] * 100)|> round(1)
  ve_overall_ub <- (conf_int_obj_overall[2] * 100) |> round(1)


  # GET NUMBERS OF CASES AND CONTROLS
  ## Identifying and removing cases with no matched controls for all age groups
  
  ids_unmatched_overall = df %>% filter(!is.na(ocv)) %>% group_by(id_case) %>% dplyr::count() %>% filter(n==1) # ids of single observations 
  matched_cases_overall <- df %>% filter(!is.na(ocv) & case_control == 1 & !id_case %in% ids_unmatched_overall$id_case) # cases with matched controls
  
  red_df_overall = df %>% filter(id_case %in% matched_cases_overall$id_case) %>% 
    dplyr::select(id_case,outcome,ocv,vac,vac_u5,age_vacc,u5) |> drop_na() # data frame for all ages, including only cases with at least 1 matched control

  ##  identifying and removing cases with no matched controls in the u5 age group
  ids_unmatched_u5 = df %>% filter(!is.na(ocv) & u5==TRUE) %>% group_by(id_case) %>% dplyr::count() %>% filter(n==1) # ids of single observations 
  matched_cases_u5 <- df %>% filter(!is.na(ocv) & u5==TRUE & case_control == 1 & !id_case %in% ids_unmatched_u5$id_case) # cases with matched controls
  
  red_df_u5 = df %>% filter(id_case %in% matched_cases_u5$id_case & u5==TRUE) %>% 
    dplyr::select(id_case,outcome,ocv,vac,vac_u5,age_vacc,u5) |> drop_na()
  
   ## identifying and removing cases with no matched controls in the ≥ 5 years age group
  
  ids_unmatched_o5 = df %>% filter(!is.na(ocv) & u5==FALSE) %>% group_by(id_case) %>% dplyr::count() %>% filter(n==1) # ids of single observations 
  matched_cases_o5 <- df %>% filter(!is.na(ocv) & u5==FALSE & case_control == 1 & !id_case %in% ids_unmatched_o5$id_case) # cases with matched controls
  
  red_df_o5 = df %>% filter(id_case %in% matched_cases_o5$id_case & u5==FALSE) %>% 
    dplyr::select(id_case,outcome,ocv,vac,vac_u5,age_vacc,u5) |> drop_na()

  ## n of cases and controls
  
  n_case_overall <- sum(red_df_overall$case_control==1)
  n_control_overall <- sum(red_df_overall$case_control==0)
  n_case_u5 <- sum(red_df_u5$case_control==1)
  n_case_o5 <- sum(red_df_o5$case_control==1 )
  n_control_u5 <- sum(red_df_u5$case_control==0)
  n_control_o5 <- sum(red_df_o5$case_control==0)

  # still need to add number of cases and controls here
  ve_df <- tribble(
    ~category, ~n_case, ~n_control, ~ve, ~ve_lb, ~ve_ub,
    "overall", n_case_overall, n_control_overall, ve_overall,ve_overall_lb, ve_overall_ub,
    "under 5 years", n_case_u5,n_control_u5, ve_u5,ve_u5_lb,ve_u5_ub,
    "5 and older", n_case_o5, n_control_o5, ve_o5,ve_o5_lb,ve_o5_ub 
  )

#   print(model)
   return(ve_df)  
}



## function for the adjusted model with age interaction 

 regress_adj_match_ageint <- function(df, ocv, confounders) {
   

   # adding some extra fields to the data frame
  df <- df |> mutate(u5=if_else(age_vacc<5,TRUE,FALSE),
                     ocv_single_dose = case_when(ocv_single_dose=="Single dose" ~ TRUE,
                     ocv_single_dose=="Not vaccinated" ~ FALSE,
                     TRUE ~ NA),
                     ocv_2dose = case_when(ocv_2dose=="Two doses" ~ TRUE,
                      ocv_2dose=="Not vaccinated" ~ FALSE,
                      TRUE ~ NA),
                     ocv_atleast_1dose=case_when(ocv_atleast_1dose=="One dose or more" ~ TRUE,
                      ocv_atleast_1dose=="Not vaccinated" ~ FALSE,
                      TRUE ~ NA), 
                     vac=case_when(.data[[ocv]]==TRUE ~ TRUE,
                                   .data[[ocv]]==FALSE ~ FALSE,
                                   TRUE ~ NA),
                     vac_u5=vac*u5,
         o5_numeric = as.numeric(1-u5),
         u5_numeric=as.numeric(u5),
         age_vac_O5_centered = age_vacc - (df |> filter(age_vacc>=5) |> dplyr::summarize(ma= mean(age_vacc)) |> dplyr::pull(ma)),
         age_vac_u5_centered = age_vacc - (df |> filter(age_vacc<5) |> dplyr::summarize(ma= mean(age_vacc)) |> dplyr::pull(ma)))
  
  if("wealth_centered" %in% colnames(df)) {

  formula <- as.formula(paste0(outcome, "~ vac + vac_u5 + o5_numeric:poly(age_vac_O5_centered, 2, raw = TRUE) + u5_numeric:age_vac_u5_centered + poly(n_hh_centered, 3, raw = TRUE) + wealth_centered", "+", paste(confounders, collapse = "+"), "+", "strata(id_case)"))

   }else{

formula <- as.formula(paste0(outcome, "~ vac + vac_u5 + o5_numeric:poly(age_vac_O5_centered, 2, raw = TRUE) + u5_numeric:age_vac_u5_centered + strata(id_case)"))

   }
  
  model  <- clogit(formula, data = df)
  
  ## define coefficients of linear function directly
  ### (ignore intercept)
  
  n_coef <- length(coef(model))
  
  ## get estimates for o5
  glht_o5 <- glht(model, linfct = t(c(1, rep(0, n_coef-1))))
  conf_int_obj_o5 <- c(1-exp(confint(glht_o5)$confint))
  ve_o5 <- (conf_int_obj_o5[1] * 100) |> round(1)
  ve_o5_lb <- (conf_int_obj_o5[3 ] * 100) |> round(1)
  ve_o5_ub <- (conf_int_obj_o5[2 ] * 100) |> round(1)

  ## get estimates for u5
  glht_u5 <- glht(model, linfct = t(c(1, 1, rep(0, n_coef-2))))
  conf_int_obj_u5 <- c(1-exp(confint(glht_u5)$confint))
  ve_u5 <- (conf_int_obj_u5[1] * 100) |> round(1)
  ve_u5_lb <- (conf_int_obj_u5[3 ] * 100) |> round(1)
  ve_u5_ub <- (conf_int_obj_u5[2 ] * 100) |> round(1)

  ## get overall estimates 
  glht_overall <- glht(model, linfct = t(c(1, mean(df$u5), rep(0, n_coef-2))))
  conf_int_obj_overall <- 1-exp(confint(glht_overall)$confint) # overall estimate weighted by proportion of cases u5
  ve_overall <- (conf_int_obj_overall[1 ] * 100) |> round(1)
  ve_overall_lb <- (conf_int_obj_overall[3 ] * 100)|> round(1)
  ve_overall_ub <- (conf_int_obj_overall[2] * 100) |> round(1)

  # GET NUMBERS OF CASES AND CONTROLS
  ## Identifying and removing cases with no matched controls for all age groups
  
  ids_unmatched_overall = df %>% filter(!is.na(ocv)) %>% group_by(id_case) %>% dplyr::count() %>% filter(n==1) # ids of single observations 
  matched_cases_overall <- df %>% filter(!is.na(ocv) & case_control == 1 & !id_case %in% ids_unmatched_overall$id_case) # cases with matched controls
  
  red_df_overall = df %>% filter(id_case %in% matched_cases_overall$id_case) %>% 
    dplyr::select(id_case,outcome,ocv,vac,vac_u5,age_vacc,u5) |> drop_na() # data frame for all ages, including only cases with at least 1 matched control

  ##  identifying and removing cases with no matched controls in the u5 age group
  ids_unmatched_u5 = df %>% filter(!is.na(ocv) & u5==TRUE) %>% group_by(id_case) %>% dplyr::count() %>% filter(n==1) # ids of single observations 
  matched_cases_u5 <- df %>% filter(!is.na(ocv) & u5==TRUE & case_control == 1 & !id_case %in% ids_unmatched_u5$id_case) # cases with matched controls
  
  red_df_u5 = df %>% filter(id_case %in% matched_cases_u5$id_case & u5==TRUE) %>% 
    dplyr::select(id_case,outcome,ocv,vac,vac_u5,age_vacc,u5) |> drop_na()
  
   ## identifying and removing cases with no matched controls in the ≥ 5 years age group
  
  ids_unmatched_o5 = df %>% filter(!is.na(ocv) & u5==FALSE) %>% group_by(id_case) %>% dplyr::count() %>% filter(n==1) # ids of single observations 
  matched_cases_o5 <- df %>% filter(!is.na(ocv) & u5==FALSE & case_control == 1 & !id_case %in% ids_unmatched_o5$id_case) # cases with matched controls
  
  red_df_o5 = df %>% filter(id_case %in% matched_cases_o5$id_case & u5==FALSE) %>% 
    dplyr::select(id_case,outcome,ocv,vac,vac_u5,age_vacc,u5) |> drop_na()
  
  ## n of cases and controls
  
  n_case_overall <- sum(red_df_overall$case_control==1)
  n_control_overall <- sum(red_df_overall$case_control==0)
  n_case_u5 <- sum(red_df_u5$case_control==1)
  n_case_o5 <- sum(red_df_o5$case_control==1 )
  n_control_u5 <- sum(red_df_u5$case_control==0)
  n_control_o5 <- sum(red_df_o5$case_control==0)

  # still need to add number of cases and controls here
  ve_df <- tribble(
    ~category, ~n_case, ~n_control, ~ve, ~ve_lb, ~ve_ub,
    "overall", n_case_overall, n_control_overall, ve_overall,ve_overall_lb,ve_overall_ub,
    "under 5 years", n_case_u5,n_control_u5, ve_u5,ve_u5_lb,ve_u5_ub,
    "5 and older", n_case_o5, n_control_o5, ve_o5,ve_o5_lb,ve_o5_ub
  )

 #  print(model)
   return(ve_df)  
}

 
```


```{r ve for a single dose, age-interaction models}

## Unadjusted VE estimates 

df_ve_single_dose_agint_unadj <- regress_unadj_match_ageint(df = df_period1, ocv =  ocv1) %>% mutate(Duration = "12-17 months") %>% 
  rbind(regress_unadj_match_ageint(df = df_period2, ocv =  ocv1)  %>% dplyr::mutate(Duration = "24-36 months")) %>% 
  dplyr::mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, n_case, n_control, ve_ci)

df_ve_2dose_agint_unadj  <- regress_unadj_match_ageint(df = df_period1, ocv =  ocv2) %>% mutate(Duration = "12-17 months") %>% 
  rbind(regress_unadj_match_ageint(df = df_period2, ocv =  ocv2)  %>% mutate(Duration = "24-36 months")) %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, n_case, n_control, ve_ci)

df_ve_atleast_1dose_agint_unadj  <- regress_unadj_match_ageint(df = df_period1, ocv =  ocv3) %>% mutate(Duration = "12-17 months") %>% 
  rbind(regress_unadj_match_ageint(df = df_period2, ocv =  ocv3)  %>% mutate(Duration = "24-36 months")) %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, n_case, n_control, ve_ci)


## Adjusted VE estimates 

### Adjusted VE for a single dose

df_ve_single_dose_agint_adj <- regress_adj_match_ageint(df = df_period1, ocv =  ocv1) %>% 
  dplyr::mutate(Duration = "12-17 months") %>% 
  rbind(regress_adj_match_ageint(df = df_period2, ocv =  ocv1, confounders = confounders) %>% 
         dplyr::mutate(Duration = "24-36 months")) %>% 
  dplyr::mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, ve_ci) %>% 
  dplyr::rename_at(vars(ve_ci), ~paste(., "adj", sep = "_")) 


## Adjusted VE for 2 doses

df_ve_2dose_agint_adj <- regress_adj_match_ageint(df = df_period1, ocv =  ocv2) %>% 
  mutate(Duration = "12-17 months") %>% 
  rbind(regress_adj_match_ageint(df = df_period2, ocv =  ocv2, confounders = confounders) %>%
          mutate(Duration = "24-36 months")) %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, ve_ci) %>% 
  rename_at(vars(ve_ci), ~paste(., "adj", sep = "_"))

## Adjusted VE for at least 1 dose

df_ve_atleast_1dose_agint_adj <- regress_adj_match_ageint(df = df_period1, ocv =  ocv3) %>% 
  mutate(Duration = "12-17 months") %>% 
  rbind(regress_adj_match_ageint(df = df_period2, ocv =  ocv3, confounders = confounders) %>% 
          mutate(Duration = "24-36 months")) %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, ve_ci) %>% 
  rename_at(vars(ve_ci), ~paste(., "adj", sep = "_"))


# Merging unadjusted and adjusted VE estimates, disaggregated by age

df_ve_single_dose_agint_merged <- df_ve_single_dose_agint_unadj %>% 
  left_join(df_ve_single_dose_agint_adj, by=c("Duration", "category"))

df_ve_atleast_1dose_agint_merged <- df_ve_atleast_1dose_agint_unadj %>% 
  left_join(df_ve_atleast_1dose_agint_adj, by=c("Duration", "category"))

df_ve_2dose_agint_merged <- df_ve_2dose_agint_unadj %>% 
  left_join(df_ve_2dose_agint_adj, by=c("Duration", "category"))


## COMBINING RETROSPECTIVE AND PROSPECTIVE CASE-CONTROL DATA
## here we only use age at vaccination variable in continuous form as a confounder (because in the retrospective study that is the only confounder variable available)

### unadjusted analysis, combined data

df_ve_single_dose_agint_unadj_comb <- regress_unadj_match_ageint(df = df_combined, ocv =  ocv1) %>% mutate(Duration = "12-36 months") %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, n_case, n_control, ve_ci)

df_ve_2dose_agint_unadj_comb <- regress_unadj_match_ageint(df = df_combined, ocv =  ocv2) %>% mutate(Duration = "12-36 months") %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, n_case, n_control, ve_ci)

df_ve_atleast_1dose_agint_unadj_comb <- regress_unadj_match_ageint(df = df_combined, ocv =  ocv3) %>% mutate(Duration = "12-36 months") %>% 
  mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, n_case, n_control, ve_ci)

### adjusted analysis, combined data

df_ve_single_dose_agint_adj_comb <- regress_adj_match_ageint(df = df_combined, ocv =  ocv1) %>% mutate(Duration = "12-36 months") %>% 
   mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, ve_ci) %>% 
  rename_at(vars(ve_ci), ~paste(., "adj", sep = "_"))

df_ve_2dose_agint_adj_comb <- regress_adj_match_ageint(df = df_combined, ocv =  ocv2) %>% mutate(Duration = "12-36 months") %>% 
   mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, ve_ci) %>% 
  rename_at(vars(ve_ci), ~paste(., "adj", sep = "_"))

df_ve_atleast_1dose_agint_adj_comb <- regress_adj_match_ageint(df = df_combined, ocv =  ocv3) %>% mutate(Duration = "12-36 months") %>% 
   mutate(ve_ci = paste0 (ve, "%", " (", ve_lb, "–", ve_ub, ")")) %>% 
  dplyr::select(Duration, category, ve_ci) %>% 
  rename_at(vars(ve_ci), ~paste(., "adj", sep = "_"))

### merging unadjusted and adjusted estimates, combined analysis with age interaction

df_ve_singledose_com_merged_agint <- df_ve_single_dose_agint_unadj_comb %>% 
  left_join(df_ve_single_dose_agint_adj_comb, by=c("Duration", "category"))


df_ve_2dose_com_merged_agint <- df_ve_2dose_agint_unadj_comb %>% 
  left_join(df_ve_2dose_agint_adj_comb, by=c("Duration", "category"))


df_ve_atleast_1dose_com_merged_ageint <- df_ve_atleast_1dose_agint_unadj_comb%>% 
  left_join(df_ve_atleast_1dose_agint_adj_comb, by=c("Duration", "category"))

# Merging combined and age-strafied VE estimates

df_ve_single_dose_all <- df_ve_single_dose_agint_merged %>% rbind(df_ve_singledose_com_merged_agint)
df_ve_two_dose_all <- df_ve_2dose_agint_merged %>% rbind(df_ve_2dose_com_merged_agint)
df_ve_atleast_1dose_all <- df_ve_atleast_1dose_agint_merged %>% rbind(df_ve_atleast_1dose_com_merged_ageint)

```



```{r output ve for manuscript, age-interaction models}

# SINGLE DOSE VE

# overall and cumulative VE, unadjusted analysis

all_ages_single_dose_unadj_cumulative <- df_ve_single_dose_all %>% 
  filter(Duration == "12-36 months" & category =="overall") %>% dplyr::select(ve_ci) %>% pull()

# overall and cumulative VE, adjusted analysis
all_ages_single_dose_adj_cumulative <- df_ve_single_dose_all %>% 
  filter(Duration == "12-36 months" & category =="overall") %>% dplyr::select(ve_ci_adj) %>% pull()

# Cumulative VE, adjusted analysis, over 5
over5_single_dose_adj_cumulative <- df_ve_single_dose_all %>% 
  filter(Duration == "12-36 months" & category =="5 and older") %>% dplyr::select(ve_ci_adj) %>% pull()

# Cumulative VE, adjusted analysis, under 5

under5_single_dose_adj_cumulative <- df_ve_single_dose_all %>% 
  filter(Duration == "12-36 months" & category =="under 5 years") %>% dplyr::select(ve_ci_adj) %>% pull()

# Stratification by time since vaccination 
# Single dose VE 12-17 months

all_ages_single_dose_unadj_year1 <- df_ve_single_dose_all %>% 
  filter(Duration == "12-17 months" & category =="overall") %>% dplyr::select(ve_ci) %>% pull()

all_ages_single_dose_adj_year1 <- df_ve_single_dose_all %>% 
  filter(Duration == "12-17 months" & category =="overall") %>% dplyr::select(ve_ci_adj) %>% pull()

over5_single_dose_unadj_year1 <- df_ve_single_dose_all %>% 
  filter(Duration == "12-17 months" & category =="5 and older") %>% dplyr::select(ve_ci) %>% pull()

over5_single_dose_adj_year1 <- df_ve_single_dose_all %>% 
  filter(Duration == "12-17 months" & category =="5 and older") %>% dplyr::select(ve_ci_adj) %>% pull()

under5_single_dose_unadj_year1 <- df_ve_single_dose_all %>% 
  filter(Duration == "12-17 months" & category =="under 5 years") %>% dplyr::select(ve_ci) %>% pull()

under5_single_dose_adj_year1 <- df_ve_single_dose_all %>% 
  filter(Duration == "12-17 months" & category =="under 5 years") %>% dplyr::select(ve_ci_adj) %>% pull()

# Single dose VE, 24-36 months

all_ages_single_dose_unadj_year2 <- df_ve_single_dose_all %>% 
  filter(Duration == "24-36 months" & category =="overall") %>% dplyr::select(ve_ci) %>% pull()

all_ages_single_dose_adj_year2 <- df_ve_single_dose_all %>% 
  filter(Duration == "24-36 months" & category =="overall") %>% dplyr::select(ve_ci_adj) %>% pull()

over5_single_dose_unadj_year2 <- df_ve_single_dose_all %>% 
  filter(Duration == "24-36 months" & category =="5 and older") %>% dplyr::select(ve_ci) %>% pull()

over5_single_dose_adj_year2 <- df_ve_single_dose_all %>% 
  filter(Duration == "24-36 months" & category =="5 and older") %>% dplyr::select(ve_ci_adj) %>% pull()

under5_single_dose_unadj_year2 <- df_ve_single_dose_all %>% 
  filter(Duration == "24-36 months" & category =="under 5 years") %>% dplyr::select(ve_ci) %>% pull()

under5_single_dose_adj_year2 <- df_ve_single_dose_all %>% 
  filter(Duration == "24-36 months" & category =="under 5 years") %>% dplyr::select(ve_ci_adj) %>% pull()


## TWO DOSES VE

over5_2dose_unadj_year1 <- df_ve_two_dose_all %>% 
  filter(Duration == "12-17 months" & category =="5 and older") %>% dplyr::select(ve_ci) %>% pull()


over5_2dose_adj_year1 <- df_ve_two_dose_all %>% 
  filter(Duration == "12-17 months" & category =="5 and older") %>% dplyr::select(ve_ci_adj) %>% pull()
```

#### Table 3. Effectiveness of a single dose of oral cholera vaccine, 12-36 months after vaccination campaigns

```{r ocv single dose, with effective n}

# rename variables to make the merging easier 
df_effective_sample <- df_effective_sample %>% 
  mutate(Duration = str_replace_all(Duration, c("One year"= "12-17 months",
                                            "Two years" = "24-36 months",
                                            "Combined" = "12-36 months",
                                            "All participants" = "overall",
                                            "Participants above 5 years of age" =  "under 5 years",
                                            "Participants above 5 years of age" = "5 and older" )),
         category = str_remove_all(Population, c( "All participants" = "overall",
                                                  "Participants under 5 years of age" =  "under 5 years",
                                                  "Participants above 5 years of age" = "5 and older" )))

# Merging effective N data set with single-dose estimates                                  

df_ve_single_dose_all = df_ve_single_dose_all %>% 
  left_join(df_effective_sample %>% 
              dplyr::select(effective_n_cases_1dose, effective_n_controls_1dose, Duration, category ), by = c("Duration", "category")) %>% 
  mutate(n_case_eff = paste0(n_case, " (", effective_n_cases_1dose, ")"),
         n_control_eff = paste0(n_control, " (", effective_n_controls_1dose, ")")) %>% 
  dplyr::select(Duration, category, n_case_eff, n_control_eff, ve_ci, ve_ci_adj)
         
# VE output for manuscript

df_ve_single_dose_all %>% 
  mutate(Duration = factor(Duration, levels = c("12-36 months", "12-17 months", "24-36 months"))) %>% 
  arrange(Duration) %>% 
  flextable::as_grouped_data(groups= "Duration") %>% 
  flextable::as_flextable() %>% 
  flextable::set_header_labels(
  values = list(
    category = "Population",
    n_case_eff = "Cases (Effective N)",
    n_control_eff = "Controls (Effective N)",
    ve_ci = "Unadjusted VE (95% CI)",
    ve_ci_adj = "Adjusted VE (95% CI)")) %>% 
flextable::autofit() %>% 
flextable::set_table_properties( width = 1, layout = "autofit") %>% 
flextable::bold(i = ~ !is.na(Duration)) %>%
flextable::align(i = ~ is.na(Duration), align = "left") 


```

